<script>
  const products = [
    { id: 1, name: 'Camiseta oversized Custom Gears', price: 119.90, img: 'https://i.postimg.cc/G3zD0FLD/camisa1.jpg', isClothing: true },
    { id: 2, name: 'Blusa moletom Custom Gears', price: 159.90, img: 'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', isClothing: true },
    { id: 3, name: 'Manopla câmbio Custom Gears', price: 65.90, img: 'https://i.postimg.cc/J04rPZ4y/volante1.jpg' },
    { id: 4, name: 'Bandeira Custom Gears', price: 54.90, img: 'https://i.postimg.cc/J04rPZ4y/volante1.jpg' },
    { id: 5, name: 'Coifa câmbio Custom Gears', price: 59.90, img: 'https://i.postimg.cc/J04rPZ4y/volante1.jpg' },
    { id: 6, name: 'Caneca personalizada Custom Gears', price: 59.90, img: 'https://i.postimg.cc/J04rPZ4y/volante1.jpg' },
    { id: 7, name: 'Chaveiro e cordão Custom Gears', price: 29.90, img: 'https://i.postimg.cc/J04rPZ4y/volante1.jpg' },
    { id: 8, name: 'Adesivos refletivo Custom Gears', price: 19.90, img: 'https://i.postimg.cc/J04rPZ4y/volante1.jpg' },
    { id: 9, name: 'Aromatizante automotivo Custom Gears', price: 6.90, img: 'https://i.postimg.cc/nVqD3dzV/chaveiro1.jpg' }
  ];

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  function renderProducts(list = products) {
    const productList = document.getElementById('productList');
    productList.innerHTML = '';
    list.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <img src="${p.img}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p>R$${p.price.toFixed(2)}</p>
        ${p.isClothing ? `
          <label for="size-${p.id}">Tamanho:</label>
          <select id="size-${p.id}">
            <option value="P">P</option>
            <option value="M">M</option>
            <option value="G">G</option>
            <option value="GG">GG</option>
          </select>
          <br><br>
          <label for="color-${p.id}">Cor:</label>
          <select id="color-${p.id}">
            <option value="Preto">Preto</option>
            <option value="Branco">Branco</option>
            <option value="Roxo">Roxo</option>
          </select>
          <br><br>
        ` : ''}
        <button onclick="addToCart(${p.id})">Adicionar ao Carrinho</button>
      `;
      productList.appendChild(div);
    });
  }

  function addToCart(id) {
    const product = products.find(p => p.id === id);
    let size = '';
    let color = '';
    if (product.isClothing) {
      size = document.getElementById(`size-${id}`).value;
      color = document.getElementById(`color-${id}`).value;
    }
    const exists = cart.find(p => p.id === id && (!product.isClothing || (p.size === size && p.color === color)));
    if (exists) {
      exists.quantity++;
    } else {
      cart.push({ ...product, quantity: 1, size, color });
    }
    saveCart();
    updateCartCount();
    showAlert(`${product.name} adicionado ao carrinho!`);
  }

  function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function updateCartCount() {
    const count = cart.reduce((total, item) => total + item.quantity, 0);
    document.getElementById('cartCount').innerText = count;
  }

  function toggleCartPopup() {
    let popup = document.querySelector('.cart-popup');
    if (!popup) createCartPopup();
    document.querySelector('.cart-popup').style.display = 'flex';
    renderCartItems();
  }

  function createCartPopup() {
    const popup = document.createElement('div');
    popup.className = 'cart-popup';
    popup.innerHTML = `
      <div class="cart-content">
        <h3>Seu Carrinho</h3>
        <div id="cartItems"></div>
        <p id="cartTotal"></p>
        <button onclick="checkout()" class="checkout">Finalizar Compra</button>
        <button onclick="closeCart()" style="margin-top:1rem;">Fechar</button>
      </div>
    `;
    document.body.appendChild(popup);
  }

  function renderCartItems() {
    const cartItems = document.getElementById('cartItems');
    cartItems.innerHTML = '';
    let total = 0;
    cart.forEach(item => {
      total += item.price * item.quantity;
      cartItems.innerHTML += `
        <p>${item.name} ${item.size ? `(${item.size}, ${item.color})` : ''} x${item.quantity} - R$${(item.price * item.quantity).toFixed(2)}
        <button class="remove" onclick="removeFromCart(${item.id}, '${item.size || ''}', '${item.color || ''}')">X</button></p>
      `;
    });
    document.getElementById('cartTotal').innerText = `Total: R$${total.toFixed(2)}`;
  }

  function removeFromCart(id, size, color) {
    cart = cart.filter(item => {
      if (item.id !== id) return true;
      if (item.size !== size) return true;
      if (item.color !== color) return true;
      return false;
    });
    saveCart();
    updateCartCount();
    renderCartItems();
  }

  function closeCart() {
    document.querySelector('.cart-popup').style.display = 'none';
  }

  function checkout() {
    let orderSummary = generateOrderSummary();
    document.querySelector('.container').innerHTML = `
      <h2>Finalizar Compra</h2>
      <p>Entre em contato no WhatsApp:</p>
      <a href="https://wa.me/5541999737694?text=${encodeURIComponent(orderSummary)}" target="_blank">
        <button class="checkout">Chamar no WhatsApp</button>
      </a>
    `;
    cart = [];
    saveCart();
    updateCartCount();
    closeCart();
  }

  function generateOrderSummary() {
    let summary = '';
    cart.forEach(item => {
      summary += `${item.quantity}x ${item.name} ${item.size ? `(${item.size}, ${item.color})` : ''} (R$${(item.price * item.quantity).toFixed(2)})\n`;
    });
    summary += `Total: R$${cart.reduce((total, item) => total + item.price * item.quantity, 0).toFixed(2)}`;
    return summary;
  }

  function filterProducts() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filtered = products.filter(p => p.name.toLowerCase().includes(term));
    renderProducts(filtered);
  }

  function showAlert(message) {
    const alertEl = document.createElement('div');
    alertEl.className = 'custom-alert';
    alertEl.innerText = message;
    document.body.appendChild(alertEl);
    setTimeout(() => alertEl.remove(), 2000);
  }

  // Voltar ao topo
  window.onscroll = function() { toggleBtnTop() };

  function toggleBtnTop() {
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
      document.getElementById('btnTop').style.display = 'block';
    } else {
      document.getElementById('btnTop').style.display = 'none';
    }
  }

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Inicializar
  renderProducts();
  updateCartCount();
</script>
