<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <!-- ===========================
       FOR√áANDO HTTPS (no servidor)
       ===========================
       ATEN√á√ÉO: para evitar hijacking, √© ESSENCIAL hospedar este
       arquivo em um dom√≠nio com certificado HTTPS v√°lido.
       -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://i.postimg.cc https://cdnjs.cloudflare.com; 
                 script-src 'self' https://cdnjs.cloudflare.com; 
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 img-src 'self' data: https://i.postimg.cc;
                 connect-src 'self'; 
                 font-src 'self' https://fonts.gstatic.com;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ùïÆùñöùñòùñôùñîùñí ùñåùñäùñÜùñóùñò</title>
  <meta name="description" content="Custom Gears - Acess√≥rios personalizados para carros e estilo streetwear." />

  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

  <!-- bcrypt.js (para hashing no front-end) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"
          integrity="sha512-ks/6LdFwKbcG3gV6bY8zVcK4E8pDFPdKZNzNqd6lUuimxFOekjRh3o/UkHo4DZklLD+6KxmDfXWmbyhPYgGT2g=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* ===========================
       RESET & ESTILIZA√á√ïES GERAIS
       ===========================
    */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #000;
      color: #fff;
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding-top: 70px;
    }
    header {
      font-family: 'UnifrakturCook', cursive;
      font-size: 3rem;
      text-align: center;
      padding: 1.5rem;
      border-bottom: 1px solid #333;
      color: #ccc;
      position: fixed;
      width: 100%;
      top: 0;
      background: #000;
      z-index: 1000;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 2rem;
      padding-top: 100px;
    }
    h2 {
      color: #aa88cc;
      font-family: 'UnifrakturCook', cursive;
      border-bottom: 1px solid #444;
      padding-bottom: 0.5rem;
      text-align: center;
    }
    button {
      background: #800080;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
      margin-top: 0.4rem;
    }
    button:hover:not(.sold-out-btn) { background: #a020f0; }
    .sold-out-btn {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* ===========================
       PRODUTOS E CARRINHO
       ===========================
    */
    .products {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.5rem;
      margin: 2rem 0;
    }
    .product {
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      width: 250px;
      padding: 1rem;
      text-align: center;
      transition: transform 0.2s ease;
      position: relative;
    }
    .product:hover { transform: scale(1.05); }
    .product img {
      width: 100%;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    .product h3 {
      color: #ddd;
      margin: 0.5rem 0;
    }
    .product .price {
      color: #ccc;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .stock-label {
      font-size: 0.9rem;
      color: #ccc;
      margin-bottom: 0.5rem;
    }
    .sold-out-text {
      color: #c00;
      font-weight: bold;
      margin-top: 0.5rem;
      display: block;
    }
    .sold-out-placeholder {
      width: 100%;
      height: 180px;
      background: #222;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #c00;
      font-size: 1.2rem;
      font-weight: bold;
    }

    /* √çcone do carrinho fixo */
    .cart {
      position: fixed;
      top: 72px;
      right: 20px;
      background: #222;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: 1px solid #444;
      box-shadow: 0 0 5px #800080;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 100px;
      z-index: 1001;
    }
    .cart-count {
      background: #800080;
      padding: 2px 8px;
      border-radius: 50%;
      margin-left: 6px;
      font-size: 0.8rem;
    }

    /* POPUP DO CARRINHO */
    .cart-popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }
    .cart-content {
      background: #333;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      max-height: 80vh;
      overflow-y: auto;
    }
    .qty-btn {
      display: inline-block;
      padding: 0 6px;
      background: #555;
      color: #fff;
      border-radius: 4px;
      margin: 0 4px;
      cursor: pointer;
    }
    .remove {
      background: #f44336 !important;
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
      margin-left: 8px;
    }
    .checkout {
      background: #4caf50 !important;
    }

    /* CUPOM DE DESCONTO */
    .coupon-section {
      margin: 1rem 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    .coupon-input {
      width: 55%;
      padding: 0.4rem;
      border-radius: 4px;
      border: 1px solid #555;
      background: #111;
      color: #fff;
      font-size: 0.9rem;
    }
    .coupon-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
    }
    .coupon-message {
      font-size: 0.9rem;
      margin-top: 0.4rem;
      color: #ccc;
      text-align: center;
    }

    /* ALERTA CUSTOMIZADO */
    .custom-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #6a0dad;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 9999;
      animation: fadein 0.5s, fadeout 0.5s 1.5s;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(-20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeout {
      from { opacity: 1; transform: translateY(0); }
      to   { opacity: 0; transform: translateY(-20px); }
    }

    /* FOOTER */
    footer {
      text-align: center;
      padding: 2rem;
      background-color: #111;
      border-top:1px solid #333;
    }
    footer h4 {
      color: #aa88cc;
      margin-bottom: 0.5rem;
    }
    footer p, footer a {
      color:#ccc;
      font-size:0.9rem;
      margin: 0.2rem 0;
    }
    footer a {
      text-decoration: none;
    }

    /* BOT√ÉO VOLTAR AO TOPO */
    #btnTop {
      display: none;
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 999;
      font-size: 1.5rem;
      outline: none;
      background-color: #800080;
      color: white;
      cursor: pointer;
      padding: 0.5rem 0.8rem;
      border: none;
      border-radius: 50%;
      box-shadow: 0 0 10px #800080;
      transition: background-color 0.3s;
    }
    #btnTop:hover { background-color: #a020f0; }
    @media (max-width:768px) {
      .products { flex-direction: column; align-items: center; }
      .product { width: 80%; }
    }

    /* =======================================================
       OVERLAY DE LOGIN / REGISTRO (invis√≠vel at√© necess√°rio)
       ======================================================= */
    #loginOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #loginBox {
      background: #111;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 350px;
      text-align: center;
    }
    #loginBox h3 {
      margin-bottom: 1rem;
      color: #aa88cc;
      font-family: 'UnifrakturCook', cursive;
    }
    #loginBox input {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border: 1px solid #444;
      border-radius: 4px;
      background: #222;
      color: #fff;
      font-size: 1rem;
    }
    #loginBox .small-link {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #ccc;
      text-decoration: underline;
      cursor: pointer;
    }
    #loginMessage, #registerMessage {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #f55;
    }
  </style>
</head>

<body>
  <!-- √çcone do Carrinho -->
  <div class="cart" onclick="toggleCartPopup()">
    üõí Carrinho <span class="cart-count" id="cartCount">0</span>
  </div>

  <!-- HEADER fixo -->
  <header>Custom Gears</header>

  <!-- CONTAINER DE PRODUTOS (sempre vis√≠vel) -->
  <div class="container" id="mainContent">
    <h2>Produtos</h2>
    <div class="products" id="productList"></div>
  </div>

  <!-- FOOTER sempre vis√≠vel -->
  <footer id="mainFooter">
    <h4>Sobre N√≥s</h4>
    <p>Na Custom Gears, transformamos paix√£o automotiva em estilo. Criamos roupas e acess√≥rios exclusivos, inspirados na cultura automotiva e no esp√≠rito livre das ruas.</p>
    <h4>Contato</h4>
    <p>Telefone: (41) 99973-7694</p>
    <p>Email: <a href="mailto:Customgears17@gmail.com">Customgears17@gmail.com</a></p>
    <h4>Redes Sociais</h4>
    <p><a href="https://www.instagram.com/custom_gears17?igsh=bmVtODg0cDk2NWEz" target="_blank">Instagram</a></p>
    <p>¬© 2025 Custom Gears. Todos os direitos reservados.</p>
  </footer>

  <!-- POPUP DO CARRINHO -->
  <div class="cart-popup" id="cartPopup">
    <div class="cart-content">
      <h3>Seu Carrinho</h3>
      <div id="cartItems"></div>

      <!-- Se√ß√£o do cupom de desconto -->
      <div class="coupon-section">
        <input type="text" id="couponCode" class="coupon-input" placeholder="Digite seu cupom">
        <button class="coupon-btn" onclick="applyCoupon()">Aplicar Cupom</button>
      </div>
      <div id="couponMessage" class="coupon-message"></div>

      <!-- Totais -->
      <p id="cartTotal"></p>
      <p id="discountedTotal" style="color:#aa88cc; font-weight:bold;"></p>

      <!-- Bot√£o de checkout: chama checkout() -->
      <button onclick="checkout()" class="checkout">Chamar no WhatsApp</button>
      <button onclick="closeCart()" style="margin-top:0.4rem;">Fechar</button>
    </div>
  </div>

  <!-- Overlay de LOGIN/REGISTRO (aparece apenas quando for preciso) -->
  <div id="loginOverlay">
    <div id="loginBox">
      <h3>Custom Gears</h3>

      <!-- FORMUL√ÅRIO DE LOGIN -->
      <div id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" autocomplete="username" />
        <input type="password" id="loginPassword" placeholder="Senha" autocomplete="current-password" />
        <button id="loginBtn" onclick="loginUser()">Entrar</button>
        <div id="loginMessage"></div>
        <div class="small-link" onclick="showRegister()">N√£o tem conta? Cadastre-se</div>
      </div>

      <!-- FORMUL√ÅRIO DE REGISTRO -->
      <div id="registerForm" style="display:none;">
        <input type="email" id="regEmail" placeholder="Seu email" autocomplete="username" />
        <input type="password" id="regPassword" placeholder="Sua senha" autocomplete="new-password" />
        <button id="registerBtn" onclick="registerUser()">Registrar</button>
        <div id="registerMessage"></div>
        <div class="small-link" onclick="showLogin()">J√° tem conta? Entrar</div>
      </div>
    </div>
  </div>

  <!-- Bot√£o de voltar ao topo -->
  <button onclick="scrollToTop()" id="btnTop" title="Voltar ao Topo">‚Üë</button>

  <script>
    /* =====================================================
         VARI√ÅVEIS GLOBAIS E DADOS INICIAIS
       ===================================================== */
    const products = [
      { id:1, name:'Camiseta oversized Custom Gears', price:119.90, img:'https://i.postimg.cc/G3zD0FLD/camisa1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['P','M','G','GG','XG'] },
      { id:2, name:'Blusa moletom com capuz Custom Gears', price:159.90, img:'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['P','M','G','GG','XG'] },
      { id:3, name:'Blusa moletom Custom Gears', price:149.90, img:'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['P','M','G','GG','XG'] },
      { id:4, name:'Cal√ßa moletom Custom Gears', price:139.90, img:'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['P','M','G','GG','XG'] },
      { id:5, name:'Meias cano alto Custom Gears', price:29.90, img:'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['M','G','GG'] },
      { id:6, name:'Manopla c√¢mbio inox Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Preto','Cinza','Cromado'], sizes:['4 polegadas'], sizePrices:{'4 polegadas':39.90} },
      { id:7, name:'Bandeira Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Preto','Branco'], sizes:['90√ó150cm','122√ó183cm'], sizePrices:{'90√ó150cm':49.90,'122√ó183cm':59.90} },
      { id:8, name:'Coifa c√¢mbio Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['Universal'], sizePrices:{'Universal':24.90} },
      { id:9, name:'Copo t√©rmico personalizado Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Preto','Branco','Cinza'], sizes:['400ml','470ml'], sizePrices:{'400ml':19.90,'470ml':24.90} },
      { id:10, name:'Chaveiro cord√£o Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['2,5cm√ó54cm','3,5cm√ó14,5cm','2,5cm√ó19cm'], sizePrices:{'2,5cm√ó54cm':29.90,'3,5cm√ó14,5cm':14.90,'2,5cm√ó19cm':19.90} },
      { id:11, name:'Adesivos refletivos Custom Gears', img:'https://i.postimg.cc/nVqD3dzV/chaveiro1.jpg', colors:['Branco','Cinza'], sizes:['100cm√ó10cm','60cm√ó6cm'], sizePrices:{'100cm√ó10cm':59.90,'60cm√ó6cm':44.90} },
      { id:12, name:'Aromatizante automotivo Custom Gears', img:'https://i.postimg.cc/nVqD3dzV/chaveiro1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['5,4cm√ó5,4cm','7,7cm√ó5,4cm'], sizePrices:{'5,4cm√ó5,4cm':7.90,'7,7cm√ó5,4cm':11.90} }
    ];

    // 2) Estoque inicial (5 unidades para cada combina√ß√£o cor|tamanho)
    const inventory = {};
    products.forEach(p => {
      inventory[p.id] = {};
      const colors = p.colors || [];
      const sizes = p.sizes || [];
      colors.forEach(c => sizes.forEach(s => {
        inventory[p.id][`${c}|${s}`] = 5;
      }));
    });

    // 3) Cupons de desconto (c√≥digo ‚Üí percentual)
    const coupons = {
      'CUSTOM10': 10,
      'CUSTOM20': 20,
      'FRETEGRATIS': 5
    };
    let appliedCoupon = null; // guarda c√≥digo de cupom se for v√°lido

    // 4) Carrinho (array de itens). Cada item: { id, color, size, quantity }
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    /* =====================================================
         L√ìGICA DE USU√ÅRIO (LOGIN / REGISTRO) ‚Äî AGORA USANDO E-MAIL
         COM BCRYPT.JS PARA HASHING
       ===================================================== */
    // Armazena array de usu√°rios no localStorage em formato: 
    // [ { email: 'x@x.com', passwordHash: '<hash bcrypt>' } ]
    function getUsers() {
      return JSON.parse(localStorage.getItem('users') || '[]');
    }
    function setUsers(arr) {
      localStorage.setItem('users', JSON.stringify(arr));
    }

    let loginAttempts = 0;       // contagem de tentativas consecutivas
    const MAX_LOGIN_ATTEMPTS = 5;
    const LOCKOUT_DURATION_MS = 15 * 60 * 1000; // 15 minutos

    let isLockedOut = false;
    let lockoutEndTime = 0;

    function showLogin() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginMessage').textContent = '';
      document.getElementById('registerMessage').textContent = '';
    }
    function showRegister() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
      document.getElementById('loginMessage').textContent = '';
      document.getElementById('registerMessage').textContent = '';
    }

    async function registerUser() {
      const emailEl = document.getElementById('regEmail');
      const passEl = document.getElementById('regPassword');
      const msgEl = document.getElementById('registerMessage');

      const email = emailEl.value.trim();
      const password = passEl.value.trim();

      // Valida√ß√£o b√°sica de email/senha
      if (!email || !password) {
        msgEl.style.color = '#f55';
        msgEl.textContent = 'Preencha e-mail e senha.';
        return;
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        msgEl.style.color = '#f55';
        msgEl.textContent = 'E-mail inv√°lido.';
        return;
      }
      if (password.length < 6) {
        msgEl.style.color = '#f55';
        msgEl.textContent = 'Senha muito curta (m√≠nimo 6 caracteres).';
        return;
      }

      const users = getUsers();
      if (users.find(u => u.email === email)) {
        msgEl.style.color = '#f55';
        msgEl.textContent = 'E-mail j√° cadastrado.';
        return;
      }

      // Gera salt e hash com bcrypt.js
      const saltRounds = 12;
      try {
        const hash = await bcrypt.hash(password, saltRounds);
        users.push({ email, passwordHash: hash });
        setUsers(users);

        msgEl.style.color = '#6a0';
        msgEl.textContent = 'Registrado com sucesso! Fa√ßa login.';
        setTimeout(showLogin, 1500);
      } catch (err) {
        console.error('Erro ao gerar hash:', err);
        msgEl.style.color = '#f55';
        msgEl.textContent = 'Erro no registro. Tente novamente.';
      }
    }

    async function loginUser() {
      const now = Date.now();
      const msgEl = document.getElementById('loginMessage');

      // Bloqueio tempor√°rio se excedeu tentativas
      if (isLockedOut && now < lockoutEndTime) {
        const remaining = Math.ceil((lockoutEndTime - now) / 1000);
        msgEl.style.color = '#f55';
        msgEl.textContent = `Bloqueado por tentativas excessivas. Tente em ${remaining}s.`;
        return;
      }
      if (isLockedOut && now >= lockoutEndTime) {
        // desbloqueia
        isLockedOut = false;
        loginAttempts = 0;
      }

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      if (!email || !password) {
        msgEl.style.color = '#f55';
        msgEl.textContent = 'Preencha e-mail e senha.';
        return;
      }

      const users = getUsers();
      const userRecord = users.find(u => u.email === email);
      if (!userRecord) {
        loginAttempts++;
        tratarFalhaLogin(msgEl);
        return;
      }

      try {
        const match = await bcrypt.compare(password, userRecord.passwordHash);
        if (!match) {
          loginAttempts++;
          tratarFalhaLogin(msgEl);
          return;
        }
      } catch (err) {
        console.error('Erro ao comparar hash:', err);
        msgEl.style.color = '#f55';
        msgEl.textContent = 'Erro interno. Tente novamente.';
        return;
      }

      // login bem-sucedido
      localStorage.setItem('currentUser', email);
      document.getElementById('loginOverlay').style.display = 'none';
      loginAttempts = 0; // zera contagem
      if (typeof pendingCheckout === 'function') {
        pendingCheckout();
        pendingCheckout = null;
      }
    }

    function tratarFalhaLogin(msgEl) {
      if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
        isLockedOut = true;
        lockoutEndTime = Date.now() + LOCKOUT_DURATION_MS;
        msgEl.style.color = '#f55';
        msgEl.textContent = 'Muitas tentativas. Bloqueado por 15 minutos.';
      } else {
        msgEl.style.color = '#f55';
        msgEl.textContent = `Credenciais inv√°lidas. ${MAX_LOGIN_ATTEMPTS - loginAttempts} tentativas restantes.`;
      }
    }

    function logoutUser() {
      localStorage.removeItem('currentUser');
      location.reload();
    }

    /* =====================================================
       FUN√á√ïES DE RENDERIZA√á√ÉO E INTERA√á√ÉO (carrinho e produtos)
       ===================================================== */
    function reconcileCartWithInventory() {
      if (!cart.length) return;
      cart.forEach(item => {
        const key = `${item.color}|${item.size}`;
        if (!inventory[item.id][key]) return;
        inventory[item.id][key] = Math.max(inventory[item.id][key] - item.quantity, 0);
      });
    }

    function renderProducts() {
      reconcileCartWithInventory();
      const list = document.getElementById('productList');
      list.innerHTML = '';

      products.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product';
        card.id = `prod-${p.id}`;

        const inStockKeys = Object.keys(inventory[p.id]).filter(k => inventory[p.id][k] > 0);

        if (inStockKeys.length === 0) {
          card.innerHTML = `
            <div class="sold-out-placeholder">ESGOTADO</div>
            <h3>${p.name}</h3>
          `;
        } else {
          const colors = [...new Set(inStockKeys.map(k => k.split('|')[0]))];
          const sizes = [...new Set(inStockKeys.map(k => k.split('|')[1]))];
          const initialSize = sizes[0];
          const initialPrice = p.sizePrices ? p.sizePrices[initialSize] : p.price;

          card.innerHTML = `
            <img src="${p.img}" alt="${p.name}"/>
            <h3>${p.name}</h3>
            <p class="price">R$${initialPrice.toFixed(2)}</p>
            <p class="stock-label">Estoque: ${inventory[p.id][`${colors[0]}|${initialSize}`]}</p>
            <label>Cor:
              <select id="cor-${p.id}">
                ${colors.map(c => `<option>${c}</option>`).join('')}
              </select>
            </label><br>
            <label>Tamanho:
              <select id="tam-${p.id}">
                ${sizes.map(s => `<option>${s}</option>`).join('')}
              </select>
            </label><br>
            <button id="btn-${p.id}">Adicionar ao Carrinho</button>
          `;
        }

        list.appendChild(card);
      });

      initProductListeners();
      updateCartCount();
    }

    function initProductListeners() {
      products.forEach(p => {
        const sizeEl = document.getElementById(`tam-${p.id}`);
        const colorEl = document.getElementById(`cor-${p.id}`);
        const btn = document.getElementById(`btn-${p.id}`);

        if (sizeEl) {
          sizeEl.addEventListener('change', () => {
            updatePriceBySize(p.id);
            updateStockLabel(p.id);
          });
        }
        if (colorEl) {
          colorEl.addEventListener('change', () => updateStockLabel(p.id));
        }
        if (btn) {
          btn.addEventListener('click', () => addToCart(p.id));
        }
      });
    }

    function updatePriceBySize(id) {
      const size = document.getElementById(`tam-${id}`).value;
      const prod = products.find(x => x.id === id);
      const price = prod.sizePrices ? prod.sizePrices[size] : prod.price;
      document.querySelector(`#prod-${id} .price`).textContent = `R$${price.toFixed(2)}`;
    }

    function updateStockLabel(id) {
      const colorSelect = document.getElementById(`cor-${id}`);
      const sizeSelect = document.getElementById(`tam-${id}`);
      if (!colorSelect || !sizeSelect) return;

      const color = colorSelect.value;
      const size = sizeSelect.value;
      const stock = inventory[id][`${color}|${size}`] || 0;
      const label = document.querySelector(`#prod-${id} .stock-label`);
      label.textContent = `Estoque: ${stock}`;
    }

    function addToCart(id) {
      const color = document.getElementById(`cor-${id}`).value;
      const size = document.getElementById(`tam-${id}`).value;
      const key = `${color}|${size}`;
      if (inventory[id][key] < 1) return;

      const existing = cart.find(i => i.id === id && i.color === color && i.size === size);
      if (existing) existing.quantity++;
      else cart.push({ id, color, size, quantity: 1 });

      inventory[id][key]--;
      localStorage.setItem('cart', JSON.stringify(cart));

      renderProducts();
      updateCartCount();
      showAlert('Adicionado ao carrinho');
    }

    function toggleCartPopup() {
      const popup = document.getElementById('cartPopup');
      if (popup.style.display === 'flex') closeCart();
      else {
        renderCartPopup();
        popup.style.display = 'flex';
      }
    }

    function renderCartPopup() {
      const container = document.getElementById('cartItems');
      container.innerHTML = '';

      if (!cart.length) {
        container.innerHTML = `<p style="color:#ccc; margin:1rem 0;">Seu carrinho est√° vazio.</p>`;
        document.getElementById('cartTotal').textContent = '';
        document.getElementById('discountedTotal').textContent = '';
        document.getElementById('couponMessage').textContent = '';
        appliedCoupon = null;
        return;
      }

      let total = 0;
      cart.forEach(item => {
        const prod = products.find(p => p.id === item.id);
        const price = prod.sizePrices ? prod.sizePrices[item.size] : prod.price;
        total += price * item.quantity;

        const div = document.createElement('div');
        div.innerHTML = `
          <p>${prod.name} ‚Äì ${item.color} / ${item.size}</p>
          <div>
            <span class="qty-btn" onclick="changeQty(${item.id}, '${item.color}', '${item.size}', -1)">‚Äì</span>
            <span>${item.quantity}</span>
            <span class="qty-btn" onclick="changeQty(${item.id}, '${item.color}', '${item.size}', 1)">+</span>
            <button class="remove" onclick="removeFromCart(${item.id}, '${item.color}', '${item.size}')">Remover</button>
          </div>
        `;
        container.appendChild(div);
      });

      document.getElementById('cartTotal').textContent = `Total: R$${total.toFixed(2)}`;

      if (appliedCoupon) {
        const discountPercent = coupons[appliedCoupon];
        const discountedValue = total * (1 - discountPercent / 100);
        document.getElementById('discountedTotal').textContent =
          `Total com "${appliedCoupon}": R$${discountedValue.toFixed(2)} (${discountPercent}% off)`;
      } else {
        document.getElementById('discountedTotal').textContent = '';
      }
      document.getElementById('couponMessage').textContent = '';
    }

    function changeQty(id, color, size, delta) {
      const key = `${color}|${size}`;
      const item = cart.find(i => i.id === id && i.color === color && i.size === size);
      if (!item) return;

      if (delta > 0 && inventory[id][key] < 1) return;
      item.quantity += delta;
      if (delta > 0) inventory[id][key]--;
      else inventory[id][key]++;

      if (item.quantity === 0) {
        cart = cart.filter(i => !(i.id === id && i.color === color && i.size === size));
      }
      localStorage.setItem('cart', JSON.stringify(cart));

      renderProducts();
      renderCartPopup();
      updateCartCount();
    }

    function removeFromCart(id, color, size) {
      const key = `${color}|${size}`;
      const item = cart.find(i => i.id === id && i.color === color && i.size === size);
      if (!item) return;

      inventory[id][key] += item.quantity;
      cart = cart.filter(i => !(i.id === id && i.color === color && i.size === size));
      localStorage.setItem('cart', JSON.stringify(cart));

      renderProducts();
      renderCartPopup();
      updateCartCount();
    }

    function closeCart() {
      document.getElementById('cartPopup').style.display = 'none';
    }

    function applyCoupon() {
      const code = document.getElementById('couponCode').value.trim().toUpperCase();
      const msgEl = document.getElementById('couponMessage');

      if (!code) {
        msgEl.style.color = '#f55';
        msgEl.textContent = 'Digite um cupom.';
        return;
      }
      if (!cart.length) {
        msgEl.style.color = '#f55';
        msgEl.textContent = 'Seu carrinho est√° vazio.';
        return;
      }
      if (coupons[code]) {
        appliedCoupon = code;
        msgEl.style.color = '#6a0';
        msgEl.textContent = `Cupom "${code}" aplicado: ${coupons[code]}% de desconto!`;
      } else {
        appliedCoupon = null;
        msgEl.style.color = '#f55';
        msgEl.textContent = `"${code}" n√£o √© um cupom v√°lido.`;
      }
      renderCartPopup();
    }

    let pendingCheckout = null;

    function checkout() {
      const currentUser = localStorage.getItem('currentUser');
      if (!cart.length) return;

      if (!currentUser) {
        pendingCheckout = checkout;
        document.getElementById('loginOverlay').style.display = 'flex';
        showLogin();
        return;
      }

      let msg = 'Ol√°, gostaria de comprar:\n';
      let total = 0;
      cart.forEach(item => {
        const prod = products.find(p => p.id === item.id);
        const unitPrice = prod.sizePrices ? prod.sizePrices[item.size] : prod.price;
        const lineTotal = unitPrice * item.quantity;
        total += lineTotal;
        msg += `- ${prod.name} (${item.color}/${item.size}) x${item.quantity} ‚Äì R$${lineTotal.toFixed(2)}\n`;
      });
      if (appliedCoupon && coupons[appliedCoupon]) {
        const discountPercent = coupons[appliedCoupon];
        const discountedValue = total * (1 - discountPercent / 100);
        msg += `\nTotal com "${appliedCoupon}": R$${discountedValue.toFixed(2)} (${discountPercent}% off)`;
      } else {
        msg += `\nTotal: R$${total.toFixed(2)}`;
      }

      const historyKey = `history_${currentUser}`;
      const previousHistory = JSON.parse(localStorage.getItem(historyKey) || '[]');
      const purchaseRecord = {
        date: new Date().toLocaleString('pt-BR'),
        items: cart.map(item => ({
          id: item.id,
          name: products.find(p => p.id === item.id).name,
          color: item.color,
          size: item.size,
          quantity: item.quantity,
          unitPrice: (products.find(p => p.id === item.id).sizePrices || {})[item.size] || products.find(p => p.id === item.id).price
        })),
        coupon: appliedCoupon || null,
        total: appliedCoupon
          ? Number((total * (1 - coupons[appliedCoupon] / 100)).toFixed(2))
          : Number(total.toFixed(2))
      };
      previousHistory.push(purchaseRecord);
      localStorage.setItem(historyKey, JSON.stringify(previousHistory));

      const phone = '5541999737694';
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');

      cart = [];
      localStorage.removeItem('cart');
      appliedCoupon = null;
      updateCartCount();
      renderProducts();
      renderCartPopup();
      closeCart();
    }

    function updateCartCount() {
      const count = cart.reduce((acc, i) => acc + i.quantity, 0);
      document.getElementById('cartCount').textContent = count;
    }

    function showAlert(text) {
      const div = document.createElement('div');
      div.className = 'custom-alert';
      div.textContent = text; // usa textContent p/ evitar inje√ß√£o de HTML
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 2000);
    }

    window.addEventListener('scroll', () => {
      const btn = document.getElementById('btnTop');
      btn.style.display = window.scrollY > 300 ? 'block' : 'none';
    });
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderProducts();
      updateCartCount();
    });
  </script>
</body>
</html>
