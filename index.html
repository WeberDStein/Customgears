/* script.js - Lógica de produtos, estoque e carrinho */

// Definição dos produtos
const products = [
  { id:1, name:'Camiseta oversized Custom Gears', price:119.90, img:'https://i.postimg.cc/G3zD0FLD/camisa1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['P','M','G','GG','XG'] },
  { id:2, name:'Blusa moletom com capuz Custom Gears', price:159.90, img:'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['P','M','G','GG','XG'] },
  { id:3, name:'Blusa moletom Custom Gears', price:149.90, img:'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['P','M','G','GG','XG'] },
  { id:4, name:'Calça moletom Custom Gears', price:139.90, img:'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['P','M','G','GG','XG'] },
  { id:5, name:'Meias cano alto Custom Gears', price:29.90, img:'https://i.postimg.cc/dtZXDB2x/manopla1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['M','G','GG'] },
  { id:6, name:'Manopla câmbio inox Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Preto','Cinza','Cromado'], sizes:['4 polegadas'], sizePrices:{'4 polegadas':39.90} },
  { id:7, name:'Bandeira Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Preto','Branco'], sizes:['90×150cm','122×183cm'], sizePrices:{'90×150cm':49.90,'122×183cm':59.90} },
  { id:8, name:'Coifa câmbio Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['Universal'], sizePrices:{'Universal':24.90} },
  { id:9, name:'Copo térmico personalizado Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Preto','Branco','Cinza'], sizes:['400ml','470ml'], sizePrices:{'400ml':19.90,'470ml':24.90} },
  { id:10, name:'Chaveiro cordão Custom Gears', img:'https://i.postimg.cc/J04rPZ4y/volante1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['2,5cm×54cm','3,5cm×14,5cm','2,5cm×19cm'], sizePrices:{'2,5cm×54cm':29.90,'3,5cm×14,5cm':14.90,'2,5cm×19cm':19.90} },
  { id:11, name:'Adesivos refletivos Custom Gears', img:'https://i.postimg.cc/nVqD3dzV/chaveiro1.jpg', colors:['Branco','Cinza'], sizes:['100cm×10cm','60cm×6cm'], sizePrices:{'100cm×10cm':59.90,'60cm×6cm':44.90} },
  { id:12, name:'Aromatizante automotivo Custom Gears', img:'https://i.postimg.cc/nVqD3dzV/chaveiro1.jpg', colors:['Branco','Preto','Cinza','Roxo'], sizes:['5,4cm×5,4cm','7,7cm×5,4cm'], sizePrices:{'5,4cm×5,4cm':7.90,'7,7cm×5,4cm':11.90} }
];

// Inicialização do inventário com 5 unidades por variação
const inventory = {};
products.forEach(p => {
  inventory[p.id] = {};
  const cols = p.colors || [];
  const szs = p.sizes || [];
  cols.forEach(c => szs.forEach(s => inventory[p.id][`${c}|${s}`]=5));
});

// Carrinho recuperado do localStorage
let cart = JSON.parse(localStorage.getItem('cart')) || [];

// Renderiza cartões de produto na página
function renderProducts() {
  const list = document.getElementById('productList');
  list.innerHTML = '';
  products.forEach(p => {
    const keyStock = Object.keys(inventory[p.id]).filter(k=>inventory[p.id][k]>0);
    const card = document.createElement('div');
    card.className = 'product'; card.id = `prod-${p.id}`;
    if (!keyStock.length) {
      card.innerHTML = `<img src="${p.img}" alt="${p.name}"/><h3>${p.name}</h3><span class="sold-out-text">Esgotado</span>`;
    } else {
      const cols = [...new Set(keyStock.map(k=>k.split('|')[0]))];
      const szs = [...new Set(keyStock.map(k=>k.split('|')[1]))];
      const initSz = szs[0];
      const initPrice = p.sizePrices?
        p.sizePrices[initSz]: p.price;
      card.innerHTML = `
        <img src="${p.img}" alt="${p.name}"/>
        <h3>${p.name}</h3>
        <p class="price">R$${initPrice.toFixed(2)}</p>
        <p class="stock-label">Estoque: ${inventory[p.id][`${cols[0]}|${initSz}`]}</p>
        <label>Cor:<select id="cor-${p.id}">${cols.map(c=>`<option>${c}</option>`).join('')}</select></label><br>
        <label>Tamanho:<select id="tam-${p.id}">${szs.map(s=>`<option>${s}</option>`).join('')}</select></label><br>
        <button id="btn-${p.id}">Adicionar ao Carrinho</button>
      `;
    }
    list.appendChild(card);
  });
  initProductListeners();
}

// Associa listeners para variações e botão de adicionar
function initProductListeners() {
  products.forEach(p => {
    const szEl = document.getElementById(`tam-${p.id}`);
    const colEl = document.getElementById(`cor-${p.id}`);
    const btn = document.getElementById(`btn-${p.id}`);
    if (szEl) szEl.addEventListener('change', ()=>{ updatePriceBySize(p.id); updateStockUI(p.id); });
    if (colEl) colEl.addEventListener('change', ()=> updateStockUI(p.id));
    if (btn) btn.addEventListener('click', ()=> addToCart(p.id));
  });
}

// Atualiza preço ao mudar tamanho
function updatePriceBySize(id) {
  const size = document.getElementById(`tam-${id}`).value;
  const prod = products.find(x=>x.id===id);
  const price = prod.sizePrices? prod.sizePrices[size]: prod.price;
  document.querySelector(`#prod-${id} .price`).textContent = `R$${price.toFixed(2)}`;
}

// Atualiza label de estoque e botão
function updateStockUI(id) {
  const color = document.getElementById(`cor-${id}`).value;
  const size = document.getElementById(`tam-${id}`).value;
  const stock = inventory[id][`${color}|${size}`]||0;
  document.querySelector(`#prod-${id} .stock-label`).textContent = `Estoque: ${stock}`;
  const btn = document.querySelector(`#prod-${id} button`);
  btn.disabled = stock===0;
  btn.classList.toggle('sold-out-btn', stock===0);
}

// Adiciona item ao carrinho
function addToCart(id) {
  const color = document.getElementById(`cor-${id}`).value;
  const size = document.getElementById(`tam-${id}`).value;
  const key = `${color}|${size}`;
  if (inventory[id][key]<1) return;
  const exist = cart.find(i=>i.id===id && i.color===color && i.size===size);
  if (exist) exist.quantity++;
  else cart.push({ id, color, size, quantity:1 });
  inventory[id][key]--;
  updateStockUI(id);
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();
  showAlert('Adicionado ao carrinho');
}

// Alterna visibilidade do popup de carrinho
function toggleCartPopup() {
  const pop = document.getElementById('cartPopup');
  if (pop.style.display==='flex') closeCart();
  else { renderCartPopup(); pop.style.display='flex'; }
}

// Renderiza conteúdo do carrinho
function renderCartPopup() {
  const cont = document.getElementById('cartItems'); cont.innerHTML='';
  let total=0;
  cart.forEach((item, idx)=>{
    const prod = products.find(p=>p.id===item.id);
    const price = prod.sizePrices? prod.sizePrices[item.size]: prod.price;
    total += price*item.quantity;
    const d = document.createElement('div');
    d.innerHTML = `
      <p><strong>${prod.name}</strong><br>Cor: ${item.color} | Tamanho: ${item.size}</p>
      <div>
        <span class="qty-btn" onclick="changeQty(${idx}, -1)">-</span>
        <span>${item.quantity}</span>
        <span class="qty-btn" onclick="changeQty(${idx}, 1)">+</span>
        <button class="remove" onclick="removeFromCart(${idx})">Remover</button>
      </div><hr>
    `;
    cont.appendChild(d);
  });
  document.getElementById('cartTotal').textContent = `Total: R$${total.toFixed(2)}`;
}

// Ajusta quantidade no carrinho
function changeQty(index, delta) {
  const item = cart[index]; if (!item) return;
  const key = `${item.color}|${item.size}`;
  if (delta>0 && inventory[item.id][key]<1) return;
  item.quantity += delta;
  inventory[item.id][key] -= delta;
  if (item.quantity<1) cart.splice(index,1);
  localStorage.setItem('cart', JSON.stringify(cart));
  renderCartPopup(); updateCartCount(); updateStockUI(item.id);
}

// Remove item do carrinho
function removeFromCart(index) {
  const item = cart[index]; if (!item) return;
  const key = `${item.color}|${item.size}`;
  inventory[item.id][key] += item.quantity;
  cart.splice(index,1);
  localStorage.setItem('cart', JSON.stringify(cart));
  renderCartPopup(); updateCartCount(); updateStockUI(item.id);
}

// Fecha popup
function closeCart() { document.getElementById('cartPopup').style.display='none'; }

// Finaliza compra via WhatsApp
function checkout() {
  const phone = '5541999737694';
  let msg = 'Olá, gostaria de comprar:%0A';
  cart.forEach(i=>{
    const p = products.find(x=>x.id===i.id);
    msg += `- ${p.name} (${i.color}/${i.size}) x${i.quantity}%0A`;
  });
  window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
}

// Atualiza contador do carrinho
function updateCartCount() {
  const cnt = cart.reduce((a,i)=>a+i.quantity,0);
  document.getElementById('cartCount').textContent = cnt;
}

// Exibe alerta customizado
function showAlert(text) {
  const a = document.createElement('div');
  a.className='custom-alert'; a.textContent=text;
  document.body.appendChild(a);
  setTimeout(()=>a.remove(),2000);
}

// Scroll para topo
function scrollToTop() { window.scrollTo({ top:0, behavior:'smooth' }); }
window.addEventListener('scroll', ()=>{
  const btn = document.getElementById('btnTop');
  btn.style.display = window.scrollY>300? 'block':'none';
});

document.addEventListener('DOMContentLoaded', ()=>{
  renderProducts();
  updateCartCount();
});
